<html lang="en" dir="ltr">

<head>
  <meta charset="utf-8">
  <title>INFO 4310 HW 2</title>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <style>
    h1, h2, h3, h4{
      text-align: center;
    }
    .flex{
      display: flex;
      flex-direction: row;
    }
    .column1, .column2{
      /*border-style: solid;*/
    }
    .column1{
      width: 60%;
    }
    .column2{
      width: 40%;
    }
    .gridlines line {
      stroke: #bbb;
    }
    .gridlines .domain {
      stroke: none;
    }
    .panel {
      width:220px;
      text-align:start;
      margin-right:20px;
      border-radius:4px;
      border: 1px solid grey;
    }
    #regionControls {
      display:flex;
      flex-direction: row;
      width:10000;
    }
    .allRegionButton {
      width:100%;
      text-align:center;
      font-size: 16px;
      background-color: white;
      border-radius:4px;
      height:30px;
    }
    .allRegionButton:hover {
      background-color: #666666;
      color:white
    }
    .panel > input {
      margin-bottom: 5px;
    }

  </style>

<body style="font-family: 'Quicksand', sans-serif;">
    <h2> Visualizing Natural Disasters Across the World</h2>
    <h3> 1900 - 2021</h3>
    <div class="flex">
      <div class="column1"> 
        <svg id="barGraph" height=600 width=1000></svg>
      <div id="regionControls">
        <div>
          <input type="button" checked onclick="selectAll(true)" value="All"> 
          <input type="button" checked onclick="selectAll(false)" value="Clear"> 
        </div>
        
        <div class="panel">
          <input type="button" class="allRegionButton" value="All of Asia">
        <div><input type="checkbox" name="SouthernAsia" onclick="highlightBars()">
          <label>Southern Asia</label>
        </div>
        <div>
          <input type="checkbox" name="South-EasternAsia" checked onclick="highlightBars()">
           <label>South-Eastern Asia</label>
        </div>
        <div>
          <input type="checkbox" name="EasternAsia" checked onclick="highlightBars()">
          <label>Eastern Asia</label>
        </div>
        <div>
          <input type="checkbox" name="WesternAsia" checked onclick="highlightBars()">
          <label>Western Asia</label>
        </div>
        <div>
           <input type="checkbox" name="CentralAsia" checked onclick="highlightBars()">
          <label>Central Asia</label>
        </div>
        </div>

         <div class="panel">
          <input type="button" class="allRegionButton" value="All of Africa">
        <div>
          <input type="checkbox" name="EasternAfrica" checked onclick="highlightBars()">
            <label>Eastern Africa</label>
        </div>
        <div>
          <input type="checkbox" name="WesternAfrica" checked onclick="highlightBars()">
          <label>Western Africa</label>
        </div>
        <div>
          <input type="checkbox" name="MiddleAfrica" checked onclick="highlightBars()">
          <label>Middle Africa</label>
        </div>
        <div>
          <input type="checkbox" name="NorthernAfrica" checked onclick="highlightBars()">
          <label>Northern Africa</label>
        </div>
        <div>
           <input type="checkbox" name="SouthernAfrica" checked onclick="highlightBars()">
           <label>Southern Africa</label>  
        </div>
        </div>
        
        <div class="panel">
          <input type="button" class="allRegionButton" value="All of Americas">
          <div>
           <input type="checkbox" name="NorthernAmerica" checked onclick="highlightBars()">
            <label>Northern America</label>
          </div>
          <div>
            <input type="checkbox" name="SouthAmerica" checked onclick="highlightBars()">
            <label>South America</label>
          </div>

          <div>
            <input type="checkbox" name="CentralAmerica" checked onclick="highlightBars()">
            <label>Central America</label>
          </div>
        </div>

        <div class="panel">
          <input type="button" class="allRegionButton" value="All of Europe">
          <div>
           <input type="checkbox" name="NorthernEurope" checked onclick="highlightBars()">
            <label>Northern Europe</label>
          </div>
          <div>
            <input type="checkbox" name="EasternEurope" checked onclick="highlightBars()">
            <label>Eastern Europe</label>
          </div>

          <div>
            <input type="checkbox" name="WesternEurope" checked onclick="highlightBars()">
            <label>Western Europe</label>
          </div>

          <div>
            <input type="checkbox" name="SouthernEurope" checked onclick="highlightBars()">
            <label>Southern Europe</label>
          </div>
        </div>

        <div class="panel">
          <input type="button" class="allRegionButton" value="All of the Rest">
          <div>
           <input type="checkbox" name="Caribbean" checked onclick="highlightBars()">
            <label>Caribbean</label>
          </div>
          <div>
            <input type="checkbox" name="Australiaand" checked onclick="highlightBars()">
            <label>Australia and New Zealand</label>
          </div>

          <div>
            <input type="checkbox" name="OceaniaIslands" checked onclick="highlightBars()">
            <label>Oceania Islands</label>
          </div>
        </div>
 
  
  </div>
  </div>
  </div>
</div>
<div id="legend"></div>
        </div>
        <svg id="lineGraph" height="600" width="850"> </svg>
      </div>
     
    </div>
    
    <script>
      // bar chart setup 
      let barGraph = d3.select('svg#barGraph');
      const barTotalWidth = barGraph.attr("width");
      const barTotalHeight = barGraph.attr("height");
      const barGraphMargin = {
        top: 10,
        right: 10,
        bottom: 120,
        left: 70
      };
      const barGraphWidth = barTotalWidth - barGraphMargin.left - barGraphMargin.right;
      const barGraphHeight = barTotalHeight - barGraphMargin.top - barGraphMargin.bottom - 10;
      let barGraphAnnotations = barGraph.append("g").attr("id", "annotations");


      // line graph setup
      let lineGraph = d3.select('svg#lineGraph');
      const lineTotalWidth = lineGraph.attr("width");
      const lineTotalHeight = lineGraph.attr("height");
      const lineGraphMargin = {
        top: 10,
        right: 10,
        bottom: 120,
        left: 70
      };
      const lineGraphWidth = lineTotalWidth - lineGraphMargin.left - lineGraphMargin.right;
      const lineGraphHeight = lineTotalHeight - lineGraphMargin.top - lineGraphMargin.bottom - 10;
      let lineGraphAnnotations = lineGraph.append("g").attr("id", "annotations");
      let lineGraphArea = lineGraph.append("g").attr("id","points")
                                    .attr("transform",`translate(${lineGraphMargin.left},${lineGraphMargin.top})`);

      const requestData = async function () {
        let disasters = await d3.csv("disasters_processed.csv", d3.autoType);
        console.log(disasters);

       

        // list of all regions we will look at 
        const regionList = [
          "Southern Asia", 
          "South-Eastern Asia", 
          "Eastern Asia", 
          "South America", 
          "Northern America", 
          "Eastern Africa", 
          "Central America",
          "Western Africa",
          "Southern Europe",
          "Caribbean",
          "Western Asia",
          "Eastern Europe",
          "Western Europe",
          "Middle Africa",
          "Oceania Islands",
          "Northern Africa",
          "Australia and New Zealand",
          "Northern Europe",
          "Southern Africa",
          "Central Asia"
        ];

        const disasterList = ["Flood", "Storm", "Earthquake", "Epidemic", "Landslide"];
        
        let regionDisasterCounts = [];
        regionList.forEach(region => {
          regionDisasterCounts.push({
            Region: region,
            Flood: 0,
            Storm: 0,
            Earthquake: 0,
            Epidemic: 0,
            Landslide: 0,
            1900: 0,
            1910: 0, 
            1920: 0,
            1930: 0, 
            1940: 0, 
            1950: 0,
            1960: 0,
            1970: 0,
            1980: 0,
            1990: 0,
            2000: 0,
            2010: 0,
            2020: 0,
            Total: 0
        });
        } );

        // if the region AND type matches then add one to the count 
        function regionDisasterCount(d, type) {
          regionDisasterCounts.forEach( regionOfObj => {
            if (d.region == regionOfObj.Region & d.disaster_type == type) {
              regionOfObj[type] += 1
              regionOfObj["Total"] += 1
              regionOfObj[d.decade] += 1
            }
          })
        }

        disasters.forEach( d => {
          if (disasterList.includes(d.disaster_type))
            regionDisasterCount( d, "Flood");
            regionDisasterCount( d, "Storm");
            regionDisasterCount( d, "Earthquake");
            regionDisasterCount( d, "Epidemic");
            regionDisasterCount( d, "Landslide");
        })

        console.log(regionDisasterCounts);

        // // Set up scales
        let regionScale = d3.scaleBand().domain(regionList).range([0,barGraphWidth]).padding(0.05)
        console.log("region test:", regionScale("Central Asia"))

        const percentScale = d3.scaleLinear()
                                .domain([0, 1])
                                .range([0, barGraphHeight]);

        colorPalette = ["#00c2de", "#fa8901", "#808080", "#f43545", "#97572b"]
        const scaleOrdinal = d3.scaleOrdinal(colorPalette);

        // // Create axes and axis labels

        let bottomAxis = d3.axisBottom(regionScale);
        barGraphAnnotations.append('g')
          .attr('class', 'x axis')
          .attr('transform', `translate(${barGraphMargin.left}, ${barGraphHeight + barGraphMargin.top + 10})`)
          .call(bottomAxis)
          .selectAll("text") 
          .style("text-anchor", "end")
          .attr("transform", "translate(-10, 2) rotate(-65)");

        let leftAxis = d3.axisLeft(percentScale);
        barGraphAnnotations.append('g')
          .attr('class', 'y axis')
          .attr('transform', `translate(${barGraphMargin.left - 10}, ${barGraphMargin.top})`)
          .call(leftAxis.tickFormat(p => {
            return Math.round((1 - p) * 100) + "%";
          }));

        barGraphAnnotations.append("text")
          .attr("class", "x label")
          .attr("text-anchor", "middle")
          .attr("x", (barGraphWidth / 2) + barGraphMargin.left)
          .attr("y", barGraphHeight + barGraphMargin.top + barGraphMargin.bottom)
          .text("Region");

        barGraphAnnotations.append("text")
          .attr("class", "y label")
          .attr("text-anchor", "middle")
          .attr("y", 5)
          .attr("x", -barGraphHeight / 2 + barGraphMargin.top)
          .attr("dy", ".6em")
          .attr("transform", "rotate(-90)")
          .text("Percent of Disasters");

        // Create bars (only if disaster has at least 1% in a region)

        let rectWidth = barGraphWidth / 20;

        regionDisasterCounts.forEach((regionObj, i) => {
          total = regionObj["Total"];
          region = regionObj["Region"]
          let nextFloor = 0;
          for (let c in regionObj) {
            wanted_bars = ['Earthquake', 'Epidemic', 'Flood', 'Landslide', 'Storm'];
            if ( wanted_bars.includes(c) ) {
              percent = regionObj[c] / total;
              regionNoSpaces = region.replace(" ", "");
                barGraph.append("rect")
                  .attr("x", regionScale(region) + barGraphMargin.left)
                  .attr("y", nextFloor + barGraphMargin.top)
                  .attr("originalPosition", nextFloor + barGraphMargin.top)
                  .attr("width", rectWidth)
                  .attr("height", percentScale(regionObj[c] / total))
                  .style("fill", scaleOrdinal(c))
                  .attr("originalFill", scaleOrdinal(c))
                  .attr("class", `bar ${c} ${regionNoSpaces}`)

                nextFloor += percentScale(regionObj[c] / total);
            }
          }
        })

        // LEGEND FUNCTIONS //
        let fixedLegend = d3.select("#legend")
        for (let i = 0; i < disasterList.length; i++) {
          let text = fixedLegend.append("text")
            .style("position", "absolute")
            .text(disasterList[i])
            .style("right", 200)
            .style("top", 190 + i * 34)
            .style("height", 50)
            .style("padding-top", "16px")
            .style("text-align", "right")
            .style("color", scaleOrdinal(disasterList[i]));
          let box = fixedLegend.append("rect")
            .style("background", scaleOrdinal(disasterList[i]))
            .style("position", "absolute")
            .style("right", 40)
            .style("top", 200 + i * 34)
            .style("width", 20)
            .style("height", 20)
          let container = fixedLegend.append("rect")
            .style("position", "absolute")
            .style("opacity", 0)
            .style("right", 40)
            .style("top", 200 + i * 34)
            .style("width", 140)
            .style("height", 50)
          container.on("mouseover", function () {
            disappear(disasterList[i])
            console.log(regionList[i])
            //disappearRegion("SouthernAsia")
          }).on("mouseout", function () {
            reappearAll()
          });
        }
        // Graph manipulation functions

        // Hides all bars except selected disaster type
        function disappear(d) {

          let goodRegions = getGoodRegions()

          let barMover = d3.selectAll('.bar')
            .filter(function () {
              return !this.classList.contains(d) && goodRegions.includes(this.classList[2]);
            });
          let op = 0;
          barMover._groups.forEach(bar => {
            bar.forEach((r, i) => {
              d3.select(r).transition().duration(200)
                .attr("opacity", 0.0);
            })
          })
          barMover = d3.selectAll(`.${d}`).filter(function () {
              return goodRegions.includes(this.classList[2]);
          });
          barMover.style("fill", scaleOrdinal(d));
          let h = 0;
          barMover._groups.forEach(bar => {
            bar.forEach((r, i) => {
              h = r.getAttribute("height");
              d3.select(r).transition().duration(500)
                .attr("opacity", 1)
                .attr("y", barGraphHeight - h + barGraphMargin.top);
            })
          })
        }

        

        highlightBars();

        // Returns graph to original position
        function reappearAll() {
          let goodRegions = getGoodRegions()
          let barMover = d3.selectAll('.bar').filter(function () {
              return goodRegions.includes(this.classList[2]);
            });
          let op = 0;
          let f = "";
          barMover._groups.forEach(bar => {
            bar.forEach((r, i) => {
              op = r.getAttribute("originalPosition");
              f = r.getAttribute("originalFill");
              d3.select(r).transition().duration(200)
                .attr("y", op)
                .attr("opacity", 1);
            })
          })
        }

        // LINE CHART

        let timeJson = {
          "earliest_date": 1900,
          "latest_date":2021,
          "min_value":1,
          "max_value":2000,
          "timeseries": []
        }

        function makeTimeSeriesForAllRegions() {

          // function to make json of timeseries for each region

          regionDisasterCounts.forEach((d) => {
            let obj = {
              "region": d.Region,
              "values": []
            }

            not_wanted_bars = ['Earthquake', 'Epidemic', 'Flood', 'Landslide', 'Storm', 'Region', 'Total'];
            
            for (let prop in d) {
              if (!not_wanted_bars.includes(prop)) {
                let yearObj = {
                  "year": prop,
                  "count": d[prop]
                }
                obj.values.push(yearObj)
              } 
            }
            timeJson.timeseries.push(obj);
          })
        }

        makeTimeSeriesForAllRegions();
        console.log(timeJson);

        const lineGraphTimeParser = d3.timeParse('%Y');
        // we already know the range of dates
        const dateExtent = [lineGraphTimeParser('1900'), lineGraphTimeParser('2021')];
        const countExtent = [0,2000];
        const countScale = d3.scaleLinear().domain(countExtent).range([lineGraphHeight, 0]);
        const dateScale = d3.scaleTime().domain(dateExtent).range([0,lineGraphWidth]);

        let lineGraphLeftAxis = d3.axisLeft(countScale);
        let lineGraphLeftGridlines = d3.axisLeft(countScale)
                                      .tickSize(-lineGraphWidth-10)
                                      .tickFormat("");
        lineGraphAnnotations.append("g")
                    .attr("class", "y axis")
                    .attr("transform",`translate(${lineGraphMargin.left-10},${lineGraphMargin.top})`)
                    .call(lineGraphLeftAxis)
        lineGraphAnnotations.append("g")
                    .attr("class", "y gridlines")
                    .attr("transform",`translate(${lineGraphMargin.left-10},${lineGraphMargin.top})`)
                    .call(lineGraphLeftGridlines);

        let lineGraphBottomAxis = d3.axisBottom(dateScale)
        let lineGraphBottomGridlines = d3.axisBottom(dateScale)
                                        .tickSize(-lineGraphWidth-10)
                                        .tickFormat("")
        lineGraphAnnotations.append("g")
                  .attr("class", "x axis")
                  .attr("transform",`translate(${lineGraphMargin.left},${lineGraphHeight+lineGraphMargin.top+10})`)
                  .call(lineGraphBottomAxis);
        lineGraphAnnotations.append("g")
                  .attr("class", "x gridlines")
                  .attr("transform",`translate(${lineGraphMargin.left},${lineGraphHeight+lineGraphMargin.top+10})`)
                  .call(lineGraphBottomGridlines);

        let lineGraphgTags = lineGraphArea.selectAll("g.g-tags").data(regionDisasterCounts)
                            .join("g")
                            .attr("class", "g-tags")
                            // .style("stroke", d => colorScale(d['track']));

        // try and figure out the lines in Danny's way ??
        regionDisasterCounts.forEach((regionObj, i) => {
          let nextFloor = 0;
          for (let c in regionObj) {
            not_wanted_bars = ['Earthquake', 'Epidemic', 'Flood', 'Landslide', 'Storm', 'Region', 'Total'];
            if ( !not_wanted_bars.includes(c) ) {
              var lineGen = d3.line()
                        .x( dateScale(lineGraphTimeParser(c)))
                        .y( countScale(regionObj[c]) )
                        .curve(d3.curveMonotoneX); 

              lineGraphArea.append("path")
                    .datum(regionObj)
                    .attr("class", "line")
                    .attr("fill", "none")  
                    .attr("stroke", "steelblue")
                    .attr("stroke-width", 3)
                    .attr("d", lineGen);
            }
          }
        })

      
      }

      requestData();

      // function that returns an array of good regions
      function getGoodRegions() {
         // good regions
          let goodRegions = []

          var markedCheckbox = document.querySelectorAll('input[type="checkbox"]:checked');
          for (var checkbox of markedCheckbox) {
            goodRegions.push(checkbox.name);
          }

          return goodRegions
      }

      // function for highlighting bars
      function highlightBars(allOrNone = "") {

          let goodRegions = getGoodRegions()

          let barMover = d3.selectAll('.bar')
            .filter(function () {
              return !goodRegions.includes(this.classList[2]);
            });
          console.log("List of bars to adjust", barMover);
          let op = 0;
          barMover._groups.forEach(bar => {
            console.log("bar", bar)
            bar.forEach((r, i) => {
              d3.select(r).transition().duration(200)
                .attr("opacity", 0.15);
            })
          })
          barMover = d3.selectAll('.bar')
            .filter(function () {
              return goodRegions.includes(this.classList[2]);
            });
          barMover._groups.forEach(bar => {
            bar.forEach((r, i) => {
              d3.select(r).transition().duration(500)
                .attr("opacity", 1)
            })
          })
        }

        function selectAll(yes) {
          document.querySelectorAll('input[type="checkbox"]').forEach(box => {
            box.checked = yes
          })
          highlightBars()
        }


    </script>
</body>
</html>
